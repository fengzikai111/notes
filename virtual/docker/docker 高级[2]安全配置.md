# docker 高级—安全配置

# Docker 安全性

在审查Docker安全性时，需要考虑四个主要方面：

- 内核的**内在安全性**及其对**命名空间**和**cgroups**的支持;
- Docker**守护进程**本身的攻击;
- 容器**配置文件**中的漏洞，默认情况下或用户自定义文件。
- 内核的“强化”安全功能以及它们如何与容器交互。

## 内核命名空间

Docker容器与LXC容器非常相似，并且它们具有类似的安全功能。当你`docker run`启动一个容器时 ，Docker为这个容器创建一组**命名空间和控制组**。

**命名空间提供了第一个也是最直接的隔离形式**：在容器中运行的进程看不到，甚至更少影响在另一个容器或主机系统中运行的进程。

**每个容器也都有自己的网络堆栈**，这意味着容器不会获得对另一个容器的**套接字或接口的特权**访问。当然，如果主机系统相应设置，容器可以通过**各自的网络接口相互交互** - 就像他们可以与外部主机进行交互一样。当您为容器指定公共端口或使用 [*链接时*](https://docs.docker.com/engine/userguide/networking/default_network/dockerlinks/) ，容器之间允许IP流量。它们可以互相ping通，发送/接收UDP数据包，并建立TCP连接，但如果需要可以限制它们。从网络体系结构的角度来看，给定Docker主机上的所有容器都位于网桥接口上。这意味着它们就像通过普通以太网交换机连接的物理机器一样，不多也不少。

## 控制组

控制组是Linux容器的另一个关键组件。他们执行**资源审计和限制**。它们提供了许多有用的度量标准，但它们也有助于确保每个**容器获得其公平的内存，CPU和磁盘IO**; 更重要的是，单个容器**不能耗尽**这些资源中的一个来降低系统的性能。

因此，尽管它们不能阻止一个容器访问或影响另一个容器的数据和进程，但它们对**抵御一些拒绝服务攻击**至关重要。它们对于多租户平台尤其重要，例如公共和私有PaaS，即使在某些应用程序开始出现故障时也能保证一致的正常运行时间（和性能）。

## Docker 守护进程攻击

使用Docker运行容器（和应用程序）意味着运行Docker守护进程。这个守护进程当前**需要`root`特权**，因此你应该知道一些重要的细节。

首先，**应该只允许受信任的用户来控制你的Docker守护进程**。这是一些强大的Docker功能的直接后果。具体来说，Docker允许在Docker主机和访客容器之间**共享一个目录**; 它允许在**不限制容器访问权限**的情况下这样做。这意味着可以启动一个容器，其`/host`目录是`/`主机上的目录; 容器可以不受任何限制地**改变你的主机文件系统**。这与虚拟化系统如何允许文件系统资源共享类似。没有什么能够阻止你与虚拟机共享你的根文件系统（甚至你的根块设备）。

这具有很强的安全意义：例如，如果您通过Web服务器来监控Docker以通过API配置容器，则应该比平时更加仔细地进行参数检查，以确保恶意用户无法传递控制的参数，从而导致Docker创建任意容器。

出于这个原因，Docker 0.5.2中更改了REST API端点（由Docker CLI用于与Docker守护进程通信），现在使用UNIX套接字而不是127.0.0.1上绑定的TCP套接字（后者容易发生如果碰巧在本地机器上直接运行Docker，而不是在虚拟机之外），则可以**发起跨站请求伪造攻击**。然后，可以使用**传统的UNIX权限检查**来限制对控制套接字的访问。

如果明确决定这么做，还可以通过HTTP公开REST API。但是，如果这样做，请注意上述安全隐患。确保它只能从**受信任的网络或VPN访问**，或者使用诸如**`stunnel`和客户端SSL证书**等机制进行保护。还可以使用[HTTPS和证书](https://docs.docker.com/engine/security/https/)来保护API端点。

守护进程也可能容易受到其他输入的影响，例如从磁盘`docker load`或从网络 加载磁盘的映像`docker pull`。从Docker 1.3.2开始，图像现在在Linux / Unix平台的chrooted子进程中提取，这是实现特权分离更广泛工作的第一步。从Docker 1.10.0开始，所有图像都通过其内容的**加密校验和进行存储和访问**，从而限制了攻击者与现有图像发生冲突的可能性。

最后，如果在服务器上运行Docker，则**建议在服务器上专门运行Docker**，并将所有其他服务移动到由Docker控制的容器中。当然，保留最喜欢的管理工具（可能至少是SSH服务器）以及现有的监控/监督流程（如NRPE和collectd）是很好的。

## Linux内核功能

默认情况下，Docker会使用一组受限制的功能启动容器。那是什么意思？

功能将二元“根/非根”二分法转变为一个细粒度的访问控制系统。只需要绑定在1024以下端口上的进程（如Web服务器）不需要以root身份运行：它们可以被赋予权限`net_bind_service`。对于几乎所有需要root权限的特定领域，还有许多其他功能。

这对于集装箱安全意义重大。让我们看看为什么！

典型的服务器运行多个进程`root`，包括SSH守护进程， `cron`守护进程，日志守护进程，内核模块，网络配置工具等。容器是不同的，因为几乎所有这些任务都是由容器周围的基础设施处理的：

- SSH访问通常由运行在Docker主机上的单个服务器管理;
- `cron`在必要时应作为用户进程运行，专门针对需要其调度服务的应用程序专门定制，而不是作为平台范围的设施;
- 日志管理通常也交给Docker，或Loggly或Splunk等第三方服务;
- 硬件管理是无关紧要的，这意味着你永远不需要`udevd`在容器中运行或等效的守护进程;
- 网络管理发生在容器的外面，执行关注点分离尽可能的，这意味着一个容器不应该需要执行`ifconfig`， `route`或IP命令（当容器被特别设计，以表现得象一个路由器或防火墙除外，当然） 。

这意味着，在大多数情况下，容器并不需要“真正的” root特权*可言*。因此，集装箱可以运行一个能力较低的集合; 这意味着容器中的“根”比真正的“根”要少得多。例如，有可能：

- 否认所有“挂载”操作;
- 拒绝访问原始套接字（以防止数据包欺骗）;
- 拒绝访问某些文件系统操作，如创建新设备节点，更改文件所有者或更改属性（包括不可变标志）;
- 拒绝模块加载;
- 和其他许多人。

这意味着即使入侵者设法升级到容器内的根目录，要做到严重的破坏或升级到主机也要困难得多。

这不会影响常规的Web应用程序，但会大大减少恶意用户的攻击媒介。默认情况下，Docker将删除除[所需](https://github.com/moby/moby/blob/master/oci/defaults.go#L14-L30)功能之外的所有功能，即白名单而不是黑名单方法。您可以在[Linux手册页中](http://man7.org/linux/man-pages/man7/capabilities.7.html)看到完整的可用功能列表。

运行Docker容器的一个主要风险是给容器默认的一组功能和挂载可能会独立提供不完全的隔离，或者与内核漏洞结合使用。

Docker支持添加和删除功能，允许使用非默认配置文件。这可能会通过删除功能使Docker更安全，或者通过增加功能降低Docker的安全性。对于用户来说，最好的做法是去除除了他们的进程明确需要的所有功能。

## 其他内核安全功能

功能只是现代Linux内核提供的许多安全功能之一。还可以利用Docker等现有知名系统，如TOMOYO，AppArmor，SELinux，GRSEC等。

虽然Docker目前仅支持功能，但不会干扰其他系统。这意味着有很多不同的方法来加固Docker主机。这里有一些例子。

- 您可以使用GRSEC和PAX运行内核。这在编译时和运行时都增加了许多安全检查; 它也击败了许多漏洞，这要归功于地址随机化等技术。它不需要特定于Docker的配置，因为这些安全特性适用于系统范围，独立于容器。
- 如果您的发行版带有Docker容器的安全模型模板，您可以直接使用它们。例如，我们发布了一个可与AppArmor配合使用的模板，而Red Hat提供了适用于Docker的SELinux策略。这些模板提供了一个额外的安全网（尽管它与功能重叠）。
- 您可以使用您最喜欢的访问控制机制来定义自己的策略。

就像您可以使用第三方工具来扩充Docker容器（包括特殊网络拓扑或共享文件系统）一样，存在用于硬化Docker容器而无需修改Docker本身的工具。

从Docker 1.10起，Docker守护进程直接支持用户命名空间。此功能允许将容器中的根用户映射到容器外部的非uid-0用户，这有助于减轻容器突破的风险。该工具可用，但默认情况下不启用。

有关此功能的更多信息，请参阅命令行参考中的[守护程序命令](https://docs.docker.com/engine/reference/commandline/dockerd/#daemon-user-namespace-options)。有关Docker中用户命名空间实现的其他信息可以在[此博客文章中](https://integratedcode.us/2015/10/13/user-namespaces-have-arrived-in-docker/)找到 。

## 结论

默认情况下，Docker容器非常安全; 特别是如果在容器内将您的进程作为非特权用户运行时。可以通过启用AppArmor，SELinux，GRSEC或其他适当的强化系统来添加额外的安全层。

