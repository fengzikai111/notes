# `hyperledger fabric` 读写集

本文档讨论了有关读写集语义的当前实现的详细信息。

# 事务模拟和读写集

在代言人**模拟交易期间**，为交易准备了**读写集**。**读集包含事务在模拟期间读取的*唯一键*及其*提交版本*的列表**。**写集**包含**唯一键的列表**（尽管可能**与读集中存在的键重叠**）以及事务写入的新值。如果**事务执行的更新是删除键**，则为键设置**删除标记**（代替新值）。

此外，如果**事务为键多次写入值**，则仅**保留最后写入的值**。此外，如果事务读取键的值，则即使**事务在发出读取之前更新了键的值**，也**会返回已提交状态的值**。换句话说，不支持`Read-your-writes`语义。

如前所述，**键的版本仅记录在读取集**中，**写集只包含事务设置的唯一键列表及其最新值**。

可以有各种方案来实现版本。**版本控制方案的最低要求是为给定密钥生成非重复标识符**。例如，对于版本使用**单调递增**的数字可以是一种这样的方案。在当前实现中，使用基于**区块链高度**的版本控制方案，其中提交**事务的高度**被用作事务**修改的所有键的最新版本**。在此方案中，**事务的高度由元组表示**（`txNumber`是块内事务的高度）。与增量数字方案相比，该方案具有许多优点。主要是，**它可以实现其他组件**，如陈述，**事务模拟和验证**，以进行**有效的设计选择**。

以下是通过**模拟假设事务**准备的示例读写集的图示。为简单起见，在插图中，使用**增量数来表示版本**。

```xml
<TxReadWriteSet>
  <NsReadWriteSet name="chaincode1">
    <read-set>
      <read key="K1", version="1">
      <read key="K2", version="1">
    </read-set>
    <write-set>
      <write key="K1", value="V1"
      <write key="K3", value="V2"
      <write key="K4", isDelete="true"
    </write-set>
  </NsReadWriteSet>
<TxReadWriteSet>
```

此外，如果事务在**模拟期间执行范围查询**，则**范围查询及其结果将作为`query-info`添加到读写集**。

# 使用读写集进行事务验证和更新世界状态

