# `gossip`数据传播协议

`Hyperledger Fabric`通过在事务执行（合法化和提交）对等体和事务排序节点之间**划分工作负载**来优化区块链**网络性能，安全性和可伸缩性**。这种**网络操作的分离**需要安全，**可靠和可扩展**的数据传播协议，以**确保数据的完整性和一致性**。为了满足这些要求，`Fabric`实现了一个`gossip`数据传播协议。

# `gossip` 协议

`Peers`利用八卦以**可扩展**的方式**广播分类帐和渠道数据**。`Gossip`**消息传递是连续**的，并且**信道上的每个对等体不断地从多个对等体接收当前和一致的分类帐数据**。每个闲聊消息都**被签名**，从而**允许拜占庭参与者**容易地识别发送**伪造消息并且防止将消息分发到不想要的目标**。受**延迟**，**网络分区**或导致**错过块**的其他原因影响的**对等方**最终将通过**联系拥有这些丢失块的对等方同步到当前分类帐状态**。

基于八卦的数据传播协议在`Fabric`网络上执行三个主要功能：

+ 通过**不断识别可用的成员对等体**并最终**检测已脱机**的对等体来**管理对等体发现和通道成员资格**。
+ **在渠道中的所有同行中传播分类帐数据**。具有与通道**其余部分不同步的数据**的任何对等体**识别丢失的块并通过复制正确的数据来同步自身**。
+ 通过允许分类帐数据的**对等状态传输更新**，使新连接的**对等端加速**。

**基于八卦的广播由对等体操作**，该对等体从该**信道上的其他对等体接收消息**，然后将这些**消息转发**到该信道上的**多个随机选择**的对等体，其中该**数量是可配置**的常数。同行也可以使用**拉动机制而不是等待传递**消息。这个**循环重复**，通道成员资格，分类帐和状态信息的结果**不断保持最新和同步**。为了传播新的块，通道上的**领导者从订购服务中提取数据**，并向其**自己组织中的同行发起八卦传播**。

# 领导选举

领导者选举机制用于**为每个组织选择一个对等体**，该**对等体将维持与订购服务的连接并且开始在其自己的组织的对等体上分发新到达的块**。利用领导者选举**为系统提供了有效利用订购服务带宽**的能力。领导者选举模块有两种可能的操作模式：

+ **Static**：系统管理员**手动将组织中的一个对等体配置为领导者**，例如**一个与订购服务保持开放连接**。
+ **Dynamic**：**对等体执行领导者选举程序**以**选择组织中的一个对等体**成为领导者，从订购服务中**拉出块**，并**将块传播给组织中的其他对等体**。

## 静态领导人选举

使用静态领导者选举允许在组织内**手动定义一组领导者对等体**，可以将**单个节点定义为领导者**或**所有可用的对等体**，应该考虑到这一点：**使太多的对等体连接到排序服务**可能**导致带宽利用效率低**下。要**启用静态领导者选举**模式，请在`core.yaml`部分中配置以下参数：

```yaml
peer:
    # Gossip related configuration
    gossip:
        useLeaderElection: false
        orgLeader: true
```

或者，可以**使用环境变量配置**和覆盖这些参数：

```sh
export CORE_PEER_GOSSIP_USELEADERELECTION=false
export CORE_PEER_GOSSIP_ORGLEADER=true
```

> **注意**：以下配置将使`peer`处于**待机模式**，即`peer`**不会尝试成为领导者**：
>
> ```sh
> export CORE_PEER_GOSSIP_USELEADERELECTION=false
> export CORE_PEER_GOSSIP_ORGLEADER=false
> ```

将`CORE_PEER_GOSSIP_USELEADERELECTION`和`CORE_PEER_GOSSIP_USELEADERELECTION`设置为`true`值是**不明确的，将导致错误**。

在静态配置组织中，`admin`负责在**出现故障或崩溃时提供领导节点的高可用性**。

## 动态领导人选举

动态领导者选举**使组织对等体能够选择一个将连接到订购服务并提取新块的对等体**。领导者**独立地**为每个组织的同伴**选举**。

**当选的领导者**有责任将**心跳信息发送给其他同伴**，作为**活跃的证据**。如果一个或多个同伴在一段时间内**没有获得心跳更新**，他们将**启动新一轮的领导者选举**程序，最终**选择新的领导者**。如果在**最坏的情况**下进行**网络分区**，则组织中将**有多个活跃的领导者**，从而**保证弹性和可用性**，从而允许组织的同行继续取得进展。在**网络分区得到修复**后，其中一个领导者将**放弃其领导地位**，因此在**稳定状态**下，每个组织**都没有网络分区**，**只有一个活跃的领导者连接到订购服务**。

以下配置**控制领导心跳消息的频率**：

```yaml
peer:
    # Gossip related configuration
    gossip:
        election:
            leaderAliveThreshold: 10s
```

为了**启用动态领导者选举**，需要在`core.yaml`中配置以下参数：

```yml
peer:
    # Gossip related configuration
    gossip:
        useLeaderElection: true
        orgLeader: false
```

或者，可以使用**环境变量配置和覆盖**这些参数：

```sh
export CORE_PEER_GOSSIP_USELEADERELECTION=true
export CORE_PEER_GOSSIP_ORGLEADER=false
```

# 锚点同行节点

八卦使用**锚定对等体来确保不同组织中的对等体彼此了解**。

当提交包含**对锚对等体的更新的配置块**时，对等体到达锚对等体并从它们获知关于**锚对等体已知的所有对等体**。一旦来自每个组织的**至少一个对等体已经联系了锚对等体**，锚对等体就会了解该对应体中的每个对等体。由于八卦沟通是不变的，并且**因为同伴总是要求被告知他们不知道的任何同伴的存在**，所以可以为**频道建立共同的成员观点**。

例如，假设在渠道中有三个组织`A，B，C`，并为组织`C`定义了一个**锚点`peer`** `peer0.orgC`。当`peer1.orgA`（来自组织`A`）联系`peer0.orgC`时，它会告诉`peer0.orgA`。而且，稍后`peer1.orgB`联系`peer0.orgC`，后者会告诉前者`peer0.orgA`。从那时起，组织`A`和`B`将开始**直接交换会员信息**，而无需`peer0.orgC`的任何帮助。

由于**跨组织的通信依赖于八卦以便工作**，因此必须在**通道配置中定义至少一个锚对等体**。**强烈建议每个组织都提供自己的一组锚点**，以实现**高可用性和冗余**。请注意，**锚点对等体不需要与领导者对等体是同一个对等体**。

# `gossip`消息

**在线**对等体通过**不断广播“活动”消息**来指示其**可用性**，每个消息**包含公钥基础结构（`PKI`）`ID`和发送者对消息的签名**。同行通过**收集这些有效信息**来**维护频道成员资格**；如果**没有对等体收到来自特定对等体的活动消息**，则**该“死”对等体最终将从通道成员资格中清除**。由于“活动”消息是**加密签名**的，因此**恶意对等方**永远不会**冒充**其他对等方，因为**它们缺少由根证书颁发机构（`CA`）授权的签名密钥**。

除了**自动转发**所接收的消息之外，状态**协调过程**还在每个信道上**跨对等体同步世界状态**。**每个对等体不断从通道上的其他对等体中提取块**，以便在**识别出差异时修复其自身状态**。由于**不需要固定连接**来维护基于八卦的数据传播，因此该过程**可靠地为共享分类帐提供数据一致性和完整性**，包括**容忍节点崩溃**。

由于**信道是隔离**的，因此一个信道上的对等体**不能在任何其他信道上发送消息或共享信息**。虽然任何对等体都可以属于**多个通道**，但是通过应用基于对等体的**通道订阅的消息路由策略**，**分区消息传递可以防止块被传播到不在通道中的对等体**。

> **注意**：1. 点对点消息的安全性**由对等`TLS`层处理，不需要签名**。**对等方通过其证书进行身份验证**，这些证书由`CA`分配。虽然也使用了`TLS`证书，但它是**在八卦层中进行身份验证的对等证书**。`Ledger`块由**订购服务签署**，然后**在渠道上交付给领导者**。
>
> 2.身份验证由**对等方的成员资格服务提供商管理**。当对等体**第一次连接到该通道**时，`TLS`会话将与成员身份**绑定**。对于**网络和信道**中的成员资格，这基本上**验证了连接对等体的每个对等体**。

