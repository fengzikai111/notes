# `hyperledger fabric` 私有数据

> **注意**：本文件假定已了解有[关私有数据](https://hyperledger-fabric.readthedocs.io/en/latest/private-data/private-data.html)的文档中的概念。

# 私有数据收集定义

**集合定义包含一个或多个集合**，每个**集合都有一个策略定义**，列出集合中的组织，以及用于在**批准时控制私有数据传播**的属性，以及可选的**是否清除数据**。

在链代码**实例化（或升级）时**，集合定义被**部署到通道**。如果使用**对等`CLI`实例化**链代码，则使用`--collections-config`标志**将集合定义文件传递给链代码实例化**。如果使用客户端`SDK`，请查看[`SDK`文档](https://fabric-sdk-node.github.io/)以获取有关提供集合定义的信息。

**集合定义由五个属性组成**：

+ `name`：集合的名称。
+ `policy`：**私有数据收集分发策略**定义允许哪些组织的**对等体持久保存**使用**签名策略语法**表示的收集数据，每个成员都**包含在`OR`签名策略列表**中。为了支持**读/写**事务，**私有数据分发策略必须定义比链代码认可策略更广泛的组织集合**，因为对等体**必须具有私有数据才能支持提议的事务**。例如，在一个拥有十个组织的渠道中，五个组织可能被纳入私人数据收集分配政策，但认可政策可能要求任何三个组织认可。
+ `requiredPeerCount`：每个支持对等方**必须在对等方签署认可之前**成功**传播私有数据**并将**提案响应返回给客户端的最小对等方**（跨授权组织）。要求传播作为**认可的条件**将确保即使认可对等方不可用，也可以在网络中获得私有数据。当`requiredPeerCount`为`0`时，表示**不需要分发**，但如果`maxPeerCount`大于零，则可能**存在一些分布**。通常**不建议使用`requiredPeerCount`**，因为如果**支持对等方变得不可用**，它**可能导致网络中的私有数据丢失**。通常，希望在**认可时间至少要求私有数据的一些分发**，以**确保网络中多个对等方上的私有数据的冗余**。
+ `maxPeerCount`：出于数据**冗余目的**，每个支持对等方**将尝试将私有数据分发到的其他对等方**（跨授权组织）的最大数量。如果认可对等体在**认可时间和提交时间**之间变得**不可用**，则作为集合成员但**在认可时间尚未接收私有数据**的其他对等体将能够从**私有数据被传播到的对等体中提取私有数据**。如果此值**设置为`0`，则不会在认可时传播私有数据**，从而**迫使**私有数据在**提交时阻止所有授权对等方**上的对等方。
+ `blockToLive`：表示数据在**块方面应在私有数据库上存在多长时间**。数据将在私有数据库上为此**指定数量的块生效，之后将被清除**，从而使这些数据从网络中**过时**。要**无限期**地保留私有数据，即**永远不会清除**私有数据，请**将`blockToLive`属性设置为`0`**。

这是一个示例集合定义`JSON`文件，包含两个集合定义的数组：

```json
[
 {
    "name": "collectionMarbles",
    "policy": "OR('Org1MSP.member', 'Org2MSP.member')",
    "requiredPeerCount": 0,
    "maxPeerCount": 3,
    "blockToLive":1000000
 },
 {
    "name": "collectionMarblePrivateDetails",
    "policy": "OR('Org1MSP.member')",
    "requiredPeerCount": 0,
    "maxPeerCount": 3,
    "blockToLive":3
 }
]
```

此示例使用`BYFN`示例网络中的组织`Org1`和`Org2`。`collectionMarbles`定义中的**策略授权组织使用私有数据**。当链代码数据需要从**订购服务节点保持私有**时，这是典型配置。但是，`collectionMarblePrivateDetails`定义中的**策略限制对通道中组织子集的访问**（在本例中为`Org1`）。在实际情况中，**渠道中将有许多组织**，每个集合中有两个或更多组织在它们之间**共享私有数据**。

# 背书

由于私有数据**未包含在提交给订购服务的交易中**，因此**未包含在分配给渠道中所有对等方的块中**，**认可同行**在**向授权组织**的**其他同行传播私人数据**方面发挥着重要作用。这确保了**通道集合中私有数据**的**可用性**，即使在**支持对等体**在其**认可后变得不可用时**也是如此。为了帮助进行这种传播，集合定义中的`maxPeerCount`和`requiredPeerCount`属性**控制着认可时间的传播程度**。

如果支持对等方**无法成功**地将私有数据**传播到至少`requiredPeerCount`**，则它将**向客户端返回错误**。**认可对等体将尝试将私有数据传播给不同组织的对等体**，以**确保每个授权组织具有私有数据的副本**。由于**事务未在链代码执行时提交**，因此**支持对等方和接收方对等方**将**私有数据的副本与区块链一起存储在本地临时存储**中，**直到提交事务为止**。



